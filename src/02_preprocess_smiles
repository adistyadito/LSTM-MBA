# src/02_preprocess_smiles.py
import pandas as pd
import os
from padelpy import padeldescriptor

def run(input_path: str, output_path: str = "data/processed/df_padel.csv"):
    """
    Generate PubChem fingerprints menggunakan PaDEL-Descriptor.
    
    Parameters
    ----------
    input_path : str
        Path ke file CSV mentah (misal: data/raw/dataset.csv)
    output_path : str
        Path ke file output fingerprint descriptor (CSV)
    """

    # === Load dataset ===
    print(f"[INFO] Loading data from {input_path}")
    df = pd.read_csv(input_path)
    
    # Validasi kolom wajib
    if "smiles" not in df.columns:
        raise ValueError("Column 'smiles' not found in dataset!")

    # === Siapkan file input untuk PaDEL ===
    temp_smi = "data/processed/temp_input.smi"
    os.makedirs(os.path.dirname(temp_smi), exist_ok=True)

    # PaDEL minta format: [SMILES][TAB][Name]
    print("[INFO] Preparing temporary SMILES file for PaDEL...")
    df[["smiles", "cid"]].to_csv(temp_smi, sep="\t", header=False, index=False)

    # === Jalankan PaDEL ===
    print("[INFO] Generating PubChem fingerprints via PaDEL (this may take a while)...")
    padeldescriptor(
        smiles=temp_smi,
        descriptors=True,
        fingerprints=True,
        d_file=output_path,
        fp4=True,  # aktifkan fingerprint 4 (PubChem)
        # bisa ditambah argumen lain kalau mau descriptor lain
    )

    print(f"[INFO] PubChem fingerprints saved to {output_path}")

    # === Hapus file sementara ===
    os.remove(temp_smi)
    print("[INFO] Temporary files cleaned up.")

    return output_path


# Example usage
if __name__ == "__main__":
    run("data/raw/dataset.csv")
